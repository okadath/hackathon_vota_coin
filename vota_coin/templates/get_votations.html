{% load static %}

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Creative Tim">
  <title>Spanish Link</title>
  <!-- Extra details for Live View on GitHub Pages -->
  <!-- Canonical SEO -->
  <!--  Social tags      -->


  <!-- <script src="js/require.js"></script> -->
  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
  <!-- Icons -->
<!--     <link rel="stylesheet" href="{% static 'assets/vendor/nucleo/css/nucleo.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'assets/vendor/fontawesome/fontawesome-free/css/all.min.css' %}" type="text/css">
 
    <link rel="stylesheet" href="  {% static 'assets/css/argon.min.css' %}" type="text/css">
    Google Tag Manager -->
    <!-- <script src="./dist/bundle.js" type="module"></script> -->

    <!-- <script type="module" src="index.js"></script>  -->
    <!-- End Google Tag Manager -->
  </head>

  <body class="bg-gradient-white">
    <!-- Google Tag Manager (noscript) -->
    <!-- End Google Tag Manager (noscript) -->
    <!-- Navbar -->


    <!-- mi mierda -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-carousel@4.0.3/dist/css/bulma-carousel.min.css"> -->

    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0"
    crossorigin="anonymous">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
    <!-- <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script> -->
 

    <section class="section">


<div class="field is-grouped">
<div class="control"> 
<a class="navbar-item" href="{% url 'home' %}">
    <button class="button is-link  ">Return main page</button>

     
  <br>
</a>

<a class="navbar-item" href="#">
    <button class="button is-link  " onclick="location.reload();">Reload Page (events not yet in frontend)</button>

     
  <br>
</a>
</div>
<br>

</div>

      <div class="container">
        <h1 class="title">
            VOTATION FOR HOLDERS
        </h1>

          <!-- in server -->
          <script src="/static/bundle.js" type="module"></script>
          <!-- in local js -->
          <!-- <script src="./dist/bundle.js" type="text/javascript"></script> -->

          <nav class="panel">
 
 
 
                 <!--  <div class="panel-block">
                    <div class="field"> -->
                      <!-- <label class="label">Los tokens han sido enviados a tu cuenta</label> -->
                     <!--  <div class="control has-icons-left has-icons-right">
                        <input class="input is-success" type="email" placeholder="Ingresa tu cuenta" name="id_email" id="id_email" >
                        <span class="icon is-small is-left">
                          <i class="fas fa-user"></i>
                        </span>
                      </div> -->

                      <br>






                                <nav class="panel">
            <p class="panel-heading">
              Votation 
            </p>

            {% if succesfull %}
            <div class="alert alert-info">
              <strong>{{ succesfull }}</strong>

            </div>
            {% endif %}
            {% if error_messages %}
            <div class="alert alert-danger">
              <strong>{{ error_messages }}</strong>
            </div>
            {% endif %}

            <br>

            <!-- <form method="post" action="{% url 'login_func' %}"> -->
              {% csrf_token %}
              <div class="panel-block">
                <div class="field">



                  <div style="display: flex; flex-direction: row; flex-wrap: wrap">
                    {% for card, points in votes_blackchain %} 
                    <div class="card" style="width: 18rem; margin: 10px"> 
                      <div class="card-body">
                        <div style="display: flex; flex-direction: row">
                          <h5 class="card-title">{{ card.name }}</h5> 
                        </div>
                        <p class="card-text">{{ card.description }}</p>
                        <p>Votes(with registry):{{card.points}}</a>
                          <p>Address:{{card.user_account_funds}}</a>
                          <p>Votes in blockchain:{{points}}</a>
                            <br>

                            <button id="{{card.user_account_funds}}"  class="btn btn-primary" onclick='call_vote("{{card.user_account_funds}}")'>Vote</a> 
                            <!-- <a href="{% url 'get_votations'  card.user_account_funds %} " id="{{card.user_account_funds}}"  class="btn btn-primary">Vote</a>  -->


                        </div>
                      </div>
                      {% endfor %}

                    </div>





                    </div>
                  </div>
                <!-- </form> -->


              </nav>


                    </div>
 

              </nav>



                </div>
              </section>


              <script type="text/javascript">

                if (typeof window.ethereum !== 'undefined') {
                          window.web3 = new Web3(window.ethereum);
        window.ethereum.enable();
      
                  console.log('MetaMask is installed!');
                }
                else{
                  console.log('install MetaMask!');
                }

    async function loadContract() {
let abi   = [
  {"inputs":[{"internalType":"uint256","name":"initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},
  {"indexed":true,"internalType":"address","name":"spender","type":"address"},
  {"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"val","type":"uint256"}],"name":"DataStored","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},
  {"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},
  {"indexed":true,"internalType":"address","name":"to","type":"address"},
  {"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
  {"inputs":[{"internalType":"address","name":"a","type":"address"},
  {"internalType":"string","name":"name","type":"string"}],"name":"adding_values","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"owner","type":"address"},
  {"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},
  {"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},
  {"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"get_list_votes_result","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"get_result_of_address","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"spender","type":"address"},
  {"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"mint_num","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"recipient","type":"address"},
  {"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"sender","type":"address"},
  {"internalType":"address","name":"recipient","type":"address"},
  {"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"propose","type":"address"},
  {"internalType":"address","name":"a","type":"address"}],"name":"vote","outputs":[],"stateMutability":"nonpayable","type":"function"}];
      // let address = "0xa1b2c3d4..."  // your contract address here
      let address= "0x23c2060D32CD4f5B958b4d3D4d66B5C808312298";

      return await new window.web3.eth.Contract(abi, address);
}
    async function getCurrentAccount() {
      
      

      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      console.log(accounts)
      const chainId = await ethereum.request({ method: 'eth_chainId' });
      console.log(chainId)
      return accounts[0];
    }

    async function call_vote(addresss) {
      // await loadWeb3();
      window.contract = await loadContract();
      const account = await getCurrentAccount();

 

      let s = await window.contract.methods.get_list_votes_result().call();
      console.log(s)


      // let sendd = await window.contract.methods.getMsgSender().call();
      // console.log(sendd)

      let balancee = await window.contract.methods.balanceOf(addresss).call();
      console.log(balancee)




      console.log(addresss)

      let result = await window.contract.methods
      .vote(account,addresss)
      .send({ from: account })
      .catch((error) => {
        console.error
        console.log("debes tener mas de 200 para votar")
        }
      );

      console.log(result)
    }


async function vote_func(address_votation) {
// var result = await contract.get_list_votes_result();


const transaction = await contract.vote(address_votation,{gasLimit: ethers.utils.parseEther("0.0001")});

const transactionReceipt = await transaction.wait();
console.log(transaction);

// if (transactionReceipt.status !== 1) {
//    alert('error message');
//    return;
// }

console.log(result);
return result;



}

    if (typeof window.ethereum !== 'undefined') {
       console.log('MetaMask is installed!');
      // run("0x518561C267F8ac931c40284c1aa06E824BABE434" )
    }


              </script>


              <!-- <script type="module" src="./static/src.a2b27638.js"></script>  -->



              </html>


